#!/usr/bin/env python
# -*- coding: utf-8 -*-

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Send the result through Gmail
# 
#
# Authors: Hao BAI (yoursbh@gmail.com)
# Version: 0.0
# Date: 28/10/2018
#
# Comments:
#     - 0.0: initial version
#     - 1.3: change message type from Plein Text to HTML (retrieve from eCentime/gmail.py)
# Description:
# The present module has 0 classes.
#   
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~



#-----------------------------------------------------------------------------------------
#                                        MODULES
#-----------------------------------------------------------------------------------------
#============================== Modules Communs ==============================
import time
import re
import base64
from email.mime.text import MIMEText
from apiclient.discovery import build
from httplib2 import Http
from oauth2client import file, client, tools
#============================== Modules Personnels ==============================
from tools import utils



#-----------------------------------------------------------------------------------------
#                                    CLASS DEFINITION
#-----------------------------------------------------------------------------------------



#-----------------------------------------------------------------------------------------
#                                  FUNCTION DEFINITION
#-----------------------------------------------------------------------------------------
def send(receiver, debug):
    sender = "Aster1"
    subject = "[aster1] Mission complete !"
    
    #============================== Message corps ==============================
    content = '''\
        <html>
        <head>
            <style>.divcss5{text-indent:2em}</style>
        </head>
            <body wsmode="compose" bgcolor="#FFFFFF" text="#000000">
            Dear,
            <br>
            Your mission on aster1.insa-rouen.fr is completed !
            <br>
            --
            <br>
            Hao BAI
            </body>
        </html>
        '''

    #============================== Message container ==============================
    messageRoot = MIMEText(content, _subtype='html', _charset='utf-8')
    messageRoot['From'] = sender
    messageRoot['To'] = receiver
    messageRoot['Subject'] = subject # Header(subject, 'utf-8')
    # Convert to base64url based strings
    messageBase64 = base64.urlsafe_b64encode(messageRoot.as_string().encode()).decode()
    messageRaw = {'raw':messageBase64} # Adapte to Google API requirement
    if debug is True: exit()

    #============================== Sending mail ==============================
    # Method 2: via Gmail API and OAuth2
    scopes = 'https://mail.google.com/'
    store = file.Storage('./gmail_credentials.json')
    creds = store.get()
    if not creds or creds.invalid:
        flow = client.flow_from_clientsecrets('./gmail_secret.json', scopes)
        creds = tools.run_flow(flow, store)
    service = build('gmail', 'v1', http=creds.authorize(Http()))

    try: 
        message = (service.users().messages().send(userId='me',body=messageRaw).execute())
        print("|- [OK] Mail sent ! (Message ID is {})".format(message['id']))
    except:
        raise

def send_mail(receiver, debug=False):
    with utils.cd('~/Eolien/Parameters/Python/site-packages/tools'):
        send(receiver=receiver, debug=debug)

#-----------------------------------------------------------------------------------------
#                                     MAIN FUNCTION
#-----------------------------------------------------------------------------------------
def main():
    send('hao.bai@insa-rouen.fr', False)
    


#-----------------------------------------------------------------------------------------
#                                      RUNNING TEST
#-----------------------------------------------------------------------------------------
if __name__ == '__main__':
        main()
