#!/usr/bin/env python
# -*- coding: utf-8 -*-

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Generate RandSeed1 for TurbSim input file
#
# Authors: Hao BAI
# Date: 22/10/2018
#
# Version:
#   - 0.0: generate random seed (retrieve ancient generateRandSeed.py)
#   - 1.0: add some more features
# 
# Comments:
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~



#!------------------------------------------------------------------------------
#!                                          MODULES PRÉREQUIS
#!------------------------------------------------------------------------------
#*============================= Modules Personnels =============================

#*============================= Modules Communs ==============================
import random
import json
import os.path
import datetime

#!------------------------------------------------------------------------------
#!                                         FONCTIONS
#!------------------------------------------------------------------------------
def manual(filename='usedRandSeed'):
    while True:
        caseName = raw_input("Enter the DLC filename: ")
        seed = random.randint(-2147483648, 2147483647)
        print("The random seed is: "+str(seed))
        # add to file
        with open(filename, 'a+') as f:
            f.write(str(seed)+" : "+caseName+"\n")
        # continue or not ?
        flag = raw_input("Exit ? (y/n): ")
        if flag == "y" or flag == "Y":
            break
    pirnt("|- [OK] All seeds are added to the file", filename)


def _get_used_seeds():
    print("|- [INFO] Loading used random seeds ...")
    history = []
    for i in (6, 10, 12, 100, 1000, 10000):
        with open('./{}seeds.json'.format(i), 'r') as f:
            seeds = json.loads(f.read())
        numbers = [s[2] for s in seeds]
        history.extend(numbers)
    
    fileliste = ["10seeds@0.1mps.json", "100seeds@0.1mps.json",
                 "1000seeds@1.0mps.json"]
    for filename in fileliste:
        with open(filename, "r") as f:
            seeds = json.loads(f.read())
        numbers = [[s[2] for s in seeds]]
        history.extend(numbers)
    return history

def auto(numberOfSeeds, speedRange, keys, allowDuplicate=False, reuseSeed=False,
    ):
    """ Generate random seeds
        INPUT
            numberOfSeeds: number of seeds per speed [int]
            speedRange: range of wind speed [range]
            keys: wind turbulence model "NTM" and/or "ETM" [list]
            allowDuplicate: whether used seed can be reused [default: False]
            reuseSeed: use the same seeds for different speeds
    """
    print("--- Seed Number Generator (Oct. 2020) ---")
    print("Requirement:")
    print("|- [INFO] {} seeds per speed in {}, that is {} seeds in total"
        .format(numberOfSeeds, speedRange, numberOfSeeds*len(speedRange)))
    data = []
    temp = []
    # load seeds that have already been used
    if allowDuplicate is False:
        print("|- [INFO] Duplicate is not allowed")
        history = _get_used_seeds()
    else:
        print("|- [INFO] Duplicate is allowed")
    # generate seeds
    if reuseSeed is False:
        print("|- [INFO] Seed is not reused for different speed")
        for key in keys:
            for v in speedRange:
                print(" |- Generating seeds for {} m/s ...".format(v))
                for i in range(numberOfSeeds):
                    if allowDuplicate is False:
                        while True:
                            seed = random.randint(-2147483648, 2147483647)
                            if seed in temp or seed in history:
                                print("  |- [ALERT] Random number {} is" 
                                    " repeated, a new one will be regenerated"
                                    .format(seed))
                            else:
                                break
                    else:
                        seed = random.randint(-2147483648, 2147483647)
                    temp.append(seed)
                    data.append((key, str(v), str(seed)))
    else:
        print("|- [INFO] Seed is reused for different speed")
        for i in range(numberOfSeeds):
            if allowDuplicate is False:
                while True:
                    seed = random.randint(-2147483648, 2147483647)
                    if seed in temp or seed in history:
                        print("|- [ALERT] Random number {} is repeated, a "
                            "new one will be regenerated".format(seed))
                    else:
                        break
            else:
                seed = random.randint(-2147483648, 2147483647)
            temp.append(seed)
        data = [(key, str(v), str(seed)) for key in keys
                for v in speedRange for seed in temp]
    print("|- [OK] Mission complete ! {} seeds are generated".format(len(data)))
    # write data by using json format
    encode = json.dumps(data, indent=4)
    # check if file already exists
    filename = str(numberOfSeeds)+'seeds.json'
    if os.path.isfile(filename):
        suffix = str(datetime.datetime.now())
        filename = filename + suffix
    # write to file
    with open(filename,'w') as f:
        f.write(encode)
    print("|- [OK] All seeds are saved to {}".format(filename))


#!------------------------------------------------------------------------------
#!                                    PROGRAMME PRINCIPALE
#!------------------------------------------------------------------------------
def main():
    # Testing manual mode
    # manual()
    # Testing auto mode
    auto(3,True)


#-------------------------------------------------------------------------------
#                                          EXÉCUTION
#-------------------------------------------------------------------------------
if __name__ == '__main__':
    main()
